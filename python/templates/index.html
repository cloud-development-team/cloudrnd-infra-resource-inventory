<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AWS Inventory Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; }
        .tab-content { margin-top: 1.5rem; }
    </style>
</head>
<body>
    <h2 class="mb-4">AWS Resource Inventory</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="resourceTabs" role="tablist">
        {% for key in resource_keys %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ key }}-tab" data-bs-toggle="tab"
                    data-resource="{{ key }}" type="button" role="tab">
                {{ key.replace('-', ' ').title() }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Table -->
    <div class="mt-3">
        <div id="status" class="text-muted mb-2">Loading...</div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Dynamic Refresh Script -->
    <script>
        let currentInterval = null;
        let currentResource = null;
    
        async function fetchResourceData(resource) {
            const status = document.getElementById('status');
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            status.innerText = `Loading ${resource}...`;
    
            try {
                const res = await axios.get(`/api/${resource}`);
                const { columns, rows } = res.data;
    
                if (!Array.isArray(rows) || rows.length === 0) {
                    thead.innerHTML = '';
                    tbody.innerHTML = '';
                    status.innerText = `No data found for ${resource}.`;
                    return;
                }
    
                thead.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
                tbody.innerHTML = rows.map(row =>
                    '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
                ).join('');
    
                status.innerText = `Showing ${resource.replace('-', ' ')} (${rows.length} items) @ ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                thead.innerHTML = '';
                tbody.innerHTML = '';
                status.innerText = `Error loading ${resource}`;
                console.error(err);
            }
        }
    
        function startAutoRefresh(resource) {
            if (currentInterval) clearInterval(currentInterval);
            currentInterval = setInterval(() => {
                if (currentResource === resource) {
                    fetchResourceData(resource);
                }
            }, 10000);
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('[data-resource]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const resource = tab.getAttribute('data-resource');
                    currentResource = resource;
                    fetchResourceData(resource);
                    startAutoRefresh(resource);
                });
            });
    
            // 첫 탭 자동 로딩
            if (tabs.length > 0) {
                const firstResource = tabs[0].getAttribute('data-resource');
                currentResource = firstResource;
                fetchResourceData(firstResource);
                startAutoRefresh(firstResource);
            }
        });
    </script>
</body>
</html>
